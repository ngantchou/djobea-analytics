# ğŸ› ï¸ Makefile DÃ©veloppement - Djobea Analytics

.PHONY: help setup dev build test clean docker-dev docker-clean

# Variables
COMPOSE_DEV_FILE := docker-compose.yml -f docker-compose.dev.yml
NODE_VERSION := $(shell node --version 2>/dev/null)
NPM_VERSION := $(shell npm --version 2>/dev/null)

# Couleurs
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

# Aide
help: ## Affiche cette aide
	@echo "$(BLUE)ğŸ› ï¸  Djobea Analytics - Commandes DÃ©veloppement$(NC)"
	@echo ""
	@echo "$(GREEN)Configuration:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E "(setup|install|config)" | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)DÃ©veloppement:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E "(dev|build|test|lint)" | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(BLUE)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Docker:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E "(docker)" | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(RED)Nettoyage:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | grep -E "(clean)" | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(RED)%-20s$(NC) %s\n", $$1, $$2}'

# VÃ©rification des prÃ©requis
check-prereqs: ## VÃ©rifier les prÃ©requis
	@echo "$(BLUE)ğŸ” VÃ©rification des prÃ©requis...$(NC)"
	@if [ -z "$(NODE_VERSION)" ]; then \
		echo "$(RED)âŒ Node.js n'est pas installÃ©$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)âœ… Node.js $(NODE_VERSION)$(NC)"; \
	fi
	@if [ -z "$(NPM_VERSION)" ]; then \
		echo "$(RED)âŒ npm n'est pas installÃ©$(NC)"; \
		exit 1; \
	else \
		echo "$(GREEN)âœ… npm $(NPM_VERSION)$(NC)"; \
	fi
	@if command -v docker >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… Docker $(shell docker --version | cut -d' ' -f3 | cut -d',' -f1)$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Docker non installÃ© (optionnel)$(NC)"; \
	fi

# Configuration complÃ¨te
setup: check-prereqs ## Configuration complÃ¨te du projet
	@echo "$(BLUE)ğŸš€ Configuration du projet...$(NC)"
	@chmod +x scripts/dev-setup.sh
	@./scripts/dev-setup.sh

setup-interactive: check-prereqs ## Configuration interactive
	@echo "$(BLUE)ğŸš€ Configuration interactive...$(NC)"
	@chmod +x scripts/dev-setup.sh
	@./scripts/dev-setup.sh --interactive

# Installation des dÃ©pendances
install: ## Installer les dÃ©pendances
	@echo "$(BLUE)ğŸ“¦ Installation des dÃ©pendances...$(NC)"
	@if [ -f "package-lock.json" ]; then \
		npm ci; \
	else \
		npm install; \
	fi
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

# Configuration de l'environnement
config: ## Configurer l'environnement
	@echo "$(BLUE)âš™ï¸  Configuration de l'environnement...$(NC)"
	@if [ ! -f ".env.local" ]; then \
		if [ -f ".env.local.example" ]; then \
			cp .env.local.example .env.local; \
			echo "$(GREEN)âœ… .env.local crÃ©Ã© depuis .env.local.example$(NC)"; \
		else \
			echo "$(YELLOW)âš ï¸  CrÃ©ez un fichier .env.local$(NC)"; \
		fi \
	else \
		echo "$(GREEN)âœ… .env.local existe$(NC)"; \
	fi

# DÃ©veloppement
dev: ## DÃ©marrer le serveur de dÃ©veloppement
	@echo "$(BLUE)ğŸš€ DÃ©marrage du serveur de dÃ©veloppement...$(NC)"
	@npm run dev

dev-debug: ## DÃ©marrer avec debug activÃ©
	@echo "$(BLUE)ğŸ› DÃ©marrage en mode debug...$(NC)"
	@DEBUG=* npm run dev

# Construction
build: ## Construire le projet
	@echo "$(BLUE)ğŸ”¨ Construction du projet...$(NC)"
	@npm run build
	@echo "$(GREEN)âœ… Construction terminÃ©e$(NC)"

build-analyze: ## Construire avec analyse des bundles
	@echo "$(BLUE)ğŸ“Š Construction avec analyse...$(NC)"
	@npm run analyze

# Tests
test: ## ExÃ©cuter tous les tests
	@echo "$(BLUE)ğŸ§ª ExÃ©cution des tests...$(NC)"
	@npm test

test-watch: ## Tests en mode watch
	@echo "$(BLUE)ğŸ‘€ Tests en mode watch...$(NC)"
	@npm run test:watch

test-coverage: ## Tests avec couverture
	@echo "$(BLUE)ğŸ“Š Tests avec couverture...$(NC)"
	@npm run test:coverage

test-e2e: ## Tests end-to-end
	@echo "$(BLUE)ğŸ­ Tests E2E...$(NC)"
	@npm run test:e2e

# QualitÃ© du code
lint: ## VÃ©rifier le code
	@echo "$(BLUE)ğŸ” VÃ©rification du code...$(NC)"
	@npm run lint

lint-fix: ## Corriger automatiquement
	@echo "$(BLUE)ğŸ”§ Correction automatique...$(NC)"
	@npm run lint:fix

type-check: ## VÃ©rification TypeScript
	@echo "$(BLUE)ğŸ“ VÃ©rification TypeScript...$(NC)"
	@npm run type-check

format: ## Formater le code
	@echo "$(BLUE)âœ¨ Formatage du code...$(NC)"
	@npm run format

format-check: ## VÃ©rifier le formatage
	@echo "$(BLUE)ğŸ” VÃ©rification du formatage...$(NC)"
	@npm run format:check

# Base de donnÃ©es
db-setup: ## Configurer la base de donnÃ©es
	@echo "$(BLUE)ğŸ—„ï¸  Configuration de la base de donnÃ©es...$(NC)"
	@npm run setup:db

db-migrate: ## ExÃ©cuter les migrations
	@echo "$(BLUE)ğŸ”„ ExÃ©cution des migrations...$(NC)"
	@npm run migrate

db-seed: ## InsÃ©rer les donnÃ©es de test
	@echo "$(BLUE)ğŸŒ± Insertion des donnÃ©es de test...$(NC)"
	@npm run seed

# Docker - DÃ©veloppement
docker-dev: ## DÃ©marrer avec Docker
	@echo "$(BLUE)ğŸ³ DÃ©marrage avec Docker...$(NC)"
	@docker-compose $(COMPOSE_DEV_FILE) up

docker-dev-build: ## DÃ©marrer avec reconstruction
	@echo "$(BLUE)ğŸ³ DÃ©marrage avec reconstruction...$(NC)"
	@docker-compose $(COMPOSE_DEV_FILE) up --build

docker-dev-detached: ## DÃ©marrer en arriÃ¨re-plan
	@echo "$(BLUE)ğŸ³ DÃ©marrage en arriÃ¨re-plan...$(NC)"
	@docker-compose $(COMPOSE_DEV_FILE) up -d

docker-logs: ## Voir les logs Docker
	@docker-compose $(COMPOSE_DEV_FILE) logs -f

docker-status: ## Statut des conteneurs
	@echo "$(BLUE)ğŸ“Š Statut des conteneurs:$(NC)"
	@docker-compose $(COMPOSE_DEV_FILE) ps

docker-shell: ## Shell dans le conteneur app
	@docker-compose $(COMPOSE_DEV_FILE) exec djobea-app sh

docker-db-shell: ## Shell dans PostgreSQL
	@docker-compose $(COMPOSE_DEV_FILE) exec postgres psql -U djobea_user -d djobea

docker-redis-shell: ## Shell dans Redis
	@docker-compose $(COMPOSE_DEV_FILE) exec redis redis-cli

# Nettoyage
clean: ## Nettoyer les fichiers temporaires
	@echo "$(YELLOW)ğŸ§¹ Nettoyage...$(NC)"
	@rm -rf .next
	@rm -rf dist
	@rm -rf coverage
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

clean-deps: ## Nettoyer et rÃ©installer les dÃ©pendances
	@echo "$(YELLOW)ğŸ§¹ Nettoyage des dÃ©pendances...$(NC)"
	@rm -rf node_modules
	@rm -f package-lock.json
	@npm install
	@echo "$(GREEN)âœ… DÃ©pendances rÃ©installÃ©es$(NC)"

docker-clean: ## Nettoyer Docker
	@echo "$(YELLOW)ğŸ§¹ Nettoyage Docker...$(NC)"
	@docker-compose $(COMPOSE_DEV_FILE) down -v
	@docker system prune -f
	@echo "$(GREEN)âœ… Docker nettoyÃ©$(NC)"

clean-all: clean clean-deps docker-clean ## Nettoyage complet

# SÃ©curitÃ©
security-audit: ## Audit de sÃ©curitÃ©
	@echo "$(BLUE)ğŸ”’ Audit de sÃ©curitÃ©...$(NC)"
	@npm audit

security-fix: ## Corriger les vulnÃ©rabilitÃ©s
	@echo "$(BLUE)ğŸ”§ Correction des vulnÃ©rabilitÃ©s...$(NC)"
	@npm audit fix

# Informations
info: ## Informations sur le projet
	@echo "$(BLUE)â„¹ï¸  Informations sur le projet:$(NC)"
	@echo "Node.js: $(NODE_VERSION)"
	@echo "npm: $(NPM_VERSION)"
	@echo "Projet: $(shell cat package.json | grep '"name"' | cut -d'"' -f4)"
	@echo "Version: $(shell cat package.json | grep '"version"' | cut -d'"' -f4)"
	@if [ -f ".env.local" ]; then \
		echo "$(GREEN)âœ… .env.local configurÃ©$(NC)"; \
	else \
		echo "$(RED)âŒ .env.local manquant$(NC)"; \
	fi

# Workflow complet
full-check: lint type-check test build ## VÃ©rification complÃ¨te
	@echo "$(GREEN)âœ… Toutes les vÃ©rifications sont passÃ©es$(NC)"

# Par dÃ©faut
.DEFAULT_GOAL := help
